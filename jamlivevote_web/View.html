<HTML>
<HEAD>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <TITLE>Live</TITLE>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1" />

    <script type="text/javascript" src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="http://code.highcharts.com/highcharts.js"></script>
    <script src="http://code.highcharts.com/modules/exporting.js"></script>

    <script>

        var webSocket;
        var username;

        function WebSocketTest() {
            if ("WebSocket" in window) {
                //webSocket = new WebSocket("ws://push.mabinogi.nexon.com/default.Socket");
                webSocket = new WebSocket("ws://4seasonpension.com:4921/WebSocketHandler.ashx");
                webSocket.onopen = function () {
                    //Connection Opened, if you want to do something while opening connection do it here
                    console.log("connected open");
                };
            }
            else {
                alert("WebSocket NOT supported by your Browser!");
            }
        }

        WebSocketTest();

        var chart1, chart2;

        var number_count1;
        var number_count2;
        var number_count3;

        var gloabl_rank1;
        var gloabl_rank2;
        var gloabl_rank3;

        number_count1 = 0;
        number_count2 = 0;
        number_count3 = 0;

        gloabl_rank1 = 1;
        gloabl_rank2 = 2;
        gloabl_rank3 = 3;


        setInterval(function () {


            var arr = [number_count1, number_count2, number_count3];
            var sorted = arr.slice().sort(function (a, b) { return b - a })
            var ranks = arr.slice().map(function (v) { return sorted.indexOf(v) + 1 });

            gloabl_rank1 = ranks[0];
            gloabl_rank2 = ranks[1];
            gloabl_rank3 = ranks[2];
        }, 1000);

        $(function () {
            $(document).ready(function () {

                chart1 = new Highcharts.Chart({
                    chart: {
                        renderTo: 'container1',
                        type: 'bar',
                        animation: Highcharts.svg, // don't animate in old IE
                        marginRight: 10,
                        events: {
                            load: function () {

                                // set up the updating of the chart each second
                                var series = this.series[0];

                                setInterval(function () {
                                    series.setData([number_count1, number_count2, number_count3]);
                                }, 1000);
                            }
                        }
                    },
                    title: {
                        text: '잼라이브 실시간 선택'
                    },
                    xAxis: {
                        categories: [
                            '1',
                            '2',
                            '3'
                        ]
                    },
                    yAxis: {
                        min: 0,
                        title: {
                            text: ''
                        },
                        labels: {
                            enabled: true,
                            formatter: function () {
                                //return parseInt((this.value  * this.value ) + 1);
                                return parseInt(this.value);
                            }
                        }
                    },
                    tooltip: {
                        formatter: function () {
                            return '' +
                                this.x + '번 : ' + parseInt(this.y) + '개';
                        }
                    },
                    legend: {
                        enabled: false
                    },
                    exporting: {
                        enabled: false
                    },
                    series: [{
                        name: 'Random data',
                        data: [{ y: 0, color: 'red' }, { y: 0, color: 'blue' }, { y: 0, color: 'green' }]
                    }]
                });
            });



        });

        // 숫자 클릭
        function selectNumber(val) {
            webSocket.send(val);
        }

        // 서버에서 메세지를 받음
        webSocket.onmessage = function (evt) {
            // 카운트를 받으면 글로벌 변수를 변경해줌
            var result_data = JSON.parse(evt.data);

            console.log(evt.data);

            var temp_number1 = 0;
            var temp_number2 = 0;
            var temp_number3 = 0;

            if (result_data.length == 0) {
                number_count1 = 0;
                number_count2 = 0;
                number_count3 = 0;
            } else {

                $.each(result_data, function (key, value) {

                    if (value.Key == '1') {
                        temp_number1 = value.Value;
                    }

                    if (value.Key == '2') {
                        temp_number2 = value.Value;
                    }

                    if (value.Key == '3') {
                        temp_number3 = value.Value;
                    }
                });

                number_count1 = temp_number1;
                number_count2 = temp_number2;
                number_count3 = temp_number3;
            }

            $(".text_number1").text(number_count1 + "개");
            $(".text_number2").text(number_count2 + "개");
            $(".text_number3").text(number_count3 + "개");

        };

        //fired when the connection gets closed
        webSocket.onclose = function () {
            alert("다시 접속해주세요.");
            location.reload();
        };

        //Fired when there comes some error in the web socket connection
        webSocket.onerror = function (error) {
            alert(error.data);
        };
    </script>
    <style>

        button {
            width: 100px;
            height: 50px;
        }

        .bar_type div {
            float: left;
        }

        .button_area {
            width: 20%;
            height: 500px;
            padding-top: 52px;
        }

            .button_area button {
                display: block;
                width: 100%;
                height: 137px;
                font-size: 20px;
            }

        .container1 {
            width: 70%;
            height: 500px;
            margin: 0 auto;
        }

        .count_area {
            width: 10%;
            height: 500px;
            padding-top: 52px;
        }

            .count_area button {
                display: block;
                width: 100%;
                height: 137px;
                font-size: 20px;
                background: 0;
                border: 0;
            }

        .container2 {
            width: 100%;
            height: 200px;
            margin: 0 auto;
        }

        .highcharts-xaxis-labels {
            display: none;
        }

        .highcharts-yaxis-labels {
            /*display: none;*/
        }
    </style>
</HEAD>
<BODY>
    <div class="bar_type">
        <div class="button_area">
            <button onclick="selectNumber('1')" value="1">1번</button>
            <button onclick="selectNumber('2')" value="2">2번</button>
            <button onclick="selectNumber('3')" value="3">3번</button>
        </div>
        <div class="container1" id="container1"></div>
        <div class="count_area">
            <button class="text_number1">0개</button>
            <button class="text_number2">0개</button>
            <button class="text_number3">0개</button>
        </div>
    </div>

    <!--
    <div class="container2" id="container2"></div>
    -->
</BODY>
</HTML>
